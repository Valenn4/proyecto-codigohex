<head>
    <title>Mostrar Transcripci√≥n</title>
    <!-- Agrega el enlace al archivo CSS de Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>
<div style="position:absolute; right: 10px; bottom:0; " class="font-montserrat bg-gray-100 flex flex-col">
    <span class="material-symbols-outlined i-chatbot" style="background-color:rgba(59,130,246,var(--tw-bg-opacity)); padding:10px; color:white; bottom: 15px; right: 15px; position:fixed; border-radius: 5px; cursor: pointer; font-size:30px">
        smart_toy
    </span>

    <div class="chatbot" style="display:none">
        <div style="display:flex; width:100%" class="bg-blue-500 text-white p-4 text-center rounded">
            <h1 class="text-2xl" style="width:50%; text-align:left">Lilly</h1>
            <span class="material-symbols-outlined close-chatbot" style="width:50%; text-align:right; margin:auto; cursor: pointer">
                close
            </span>
        </div>

        <div id="conversation" style="height: 250px;overflow:scroll; bottom: 0;" class="flex-1 p-4 bg-white mt-4 rounded">
            <div class="flex items-start mb-2">
                <div class="bg-gray-300 p-2 rounded-tl rounded-tr rounded-br">
                    <p class="text-gray-800">Hola soy Lilly, escribe algo para comenzar...</p>
                </div>
            </div>
            {{respuesta}}
        </div>

        <form method="post" class="formText">
            {% csrf_token %}
            <input type="text" class="input_message" name="message" placeholder="Escribe un mensaje">
            <button type="submit" name="submit_message" value="Mandar" class="bg-blue-500 hover:bg-blue-700 text-white p-2 rounded transition duration-300">
                <span class="material-symbols-outlined">
                    send
                </span>
            </button>
        </form>

        <form method="post" id="formAudio" action="{% url 'grabar_audio' %}" class="p-4">
            {% csrf_token %}
            <input type="hidden" name="template_name" value="{% if request.resolver_match.url_name %}{{ request.resolver_match.url_name }}{% endif %}">
            <button id="grabarForm" name="formAudio" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white p-2 rounded transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                    Grabar Mensaje
                </svg>
                
            </button>
        </form>
    </div>



    <script>
        document.querySelector(".i-chatbot").addEventListener("click", () => {
            document.querySelector(".i-chatbot").style.display = 'none'
            document.querySelector(".chatbot").style.display = 'block'
        })
        document.querySelector(".close-chatbot").addEventListener("click", () => {
            document.querySelector(".i-chatbot").style.display = 'block'
            document.querySelector(".chatbot").style.display = 'none'
        })


        document.querySelector(".formText").addEventListener("submit", (e) => {
            e.preventDefault();
            let message = e.target.message
            fetch(`http://127.0.0.1:8000/api/chatbot/${message.value}`)
            .then(response => response.json())
            .then(json => {
                if (json == '../juegos'){
                    location.href = '../juegos'
                } else if (json == '../calendario'){
                    location.href = '../calendario'
                } else {
                    document.getElementById("conversation").insertAdjacentHTML('beforeend', `
                        <div class="flex items-end mb-2">
                            <div class="bg-blue-500 text-white p-2 rounded-tl rounded-tr rounded-bl self-end">
                                <p>${message.value}</p>
                            </div>
                        </div>
                        <div class="flex items-start mb-2">
                            <div class="bg-gray-300 p-2 rounded-tl rounded-tr rounded-br">
                                <p class="text-gray-800">Lilly: ${json}</p>
                            </div>
                        </div>
                    `)
                }
                message.focus()
                e.target.submit_message.blur()
                e.target.reset()
            })
        });
        
        document.getElementById("grabarForm").addEventListener("submit", function (event) {
            event.preventDefault();
            
            var formData = new FormData(form);
            var url = form.getAttribute('action');
    
            fetch(url, {
                method: 'GET',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if ('redirect' in data) {
                    window.location.href = data.redirect;
                } else if ('error' in data) {
                    // Manejar el error
                    console.error(data.error);
                } else {
                    console.log(data)
                }
            })
            .catch(error => {
                console.error(error);
            });
        });
    </script>
</div>
